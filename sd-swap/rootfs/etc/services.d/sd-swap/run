#!/usr/bin/with-contenv bashio
# ==============================================================================
# SD Card Swap â€” main service entry point
# Starts the nginx web server for the ingress UI
# ==============================================================================

bashio::log.info "Starting SD Card Swap add-on..."

# Read the ingress entry path from the Supervisor
ingress_entry=$(bashio::addon.ingress_entry)
bashio::log.info "Ingress entry: ${ingress_entry}"

export INGRESS_ENTRY="${ingress_entry}"
export INGRESS_PORT="8099"

# Ensure nginx runtime dirs exist
mkdir -p /run/nginx /var/lib/nginx/tmp

# Generate nginx config from template
sed "s|%%INGRESS_ENTRY%%|${ingress_entry}|g; s|%%INGRESS_PORT%%|${INGRESS_PORT}|g" \
    /etc/nginx/nginx.conf.tpl > /etc/nginx/nginx.conf

bashio::log.info "Starting nginx on port ${INGRESS_PORT}..."
exec nginx -c /etc/nginx/nginx.conf -g "daemon off;"
